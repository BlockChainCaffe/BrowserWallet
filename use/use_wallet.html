<html>
  <body>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script charset="utf-8" src="../dist/ethers-v4.min.js" type="text/javascript"></script>
        <script type="text/javascript" src="../dist/FileSaver.js"></script>
        <script type="text/javascript" src="../dist/qrcode.js"></script>
        <!-- <script type="text/javascript" src="../dist/web3.min.js"></script> -->
        
        <script>

            // ---- GLOBALS ----------------------------------------------------------------------------------------

            // Wallet parameters
            var wallet;
            var wpass;
            var seed;
            var addr;
            var priv;
            var json;
            var reader = new FileReader();

            var provider;

            // ---- FUNCTIONS --------------------------------------------------------------------------------------
            
            function selectProvider() {
                var sel = document.f1.select_provider.value;
                switch (sel)
                {
                    case "M" : 
                        provider = new ethers.providers.Web3Provider(web3.currentProvider);
                        document.getElementById('out_provider').innerHTML = "Metamask";
                        break;
                    // case "I" : 
                    //     provider = new ethers.providers.IpcProvider("/home/quadrans/.quadrans/geth.ipc");
                    //     break;
                    // case "T" : 
                    //     provider = new ethers.providers.IpcProvider("/home/quadrans/.quadrans/testnet/geth.ipc");
                    //     break;
                    case "R" : 
                        provider = new ethers.providers.JsonRpcProvider("http://164.68.121.219:8545");
                        // provider = new ethers.providers.JsonRpcProvider({ "url" : "http://164.68.121.219:8545", "allowInsecure" : true, });
                        document.getElementById('out_provider').innerHTML = "Remote";
                        break;
                    case "L" : 
                        provider = new ethers.providers.JsonRpcProvider("http://localhost:8545");
                        document.getElementById('out_provider').innerHTML = "Local";
                        break;
                }
                
                console.log(provider);
                provider.getBalance(addr).then((bal) => { document.getElementById('out_balance').innerHTML = "Balance : "+ethers.utils.formatEther(bal)});
                provider.getBalance("0x55331412dd110E0914bcFB7C56e9b58c48798745").then((bal) => {console.log(ethers.utils.formatEther(bal))});
                provider.getNetwork().then((n) => { document.getElementById('out_provider').innerHTML += JSON.stringify(n)});
                provider.getBlockNumber().then((n) => { document.getElementById('out_provider').innerHTML += "Blocks : "+ n });
            }

            function creation_progress(p) {
                document.getElementById('out_creation').innerHTML = "Restoring Wallet : " + parseInt(p * 100) + "%";
            }

            function importJ() {
                wpass = document.getElementById('password').value;
                var file = document.getElementById('files').files[0];
                reader.readAsText(file, "UTF-8");
                reader.onload = function (evt) {
                    // read json
                    json = reader.result;
                    // get keystore from json
                    ethers.Wallet.fromEncryptedJson(json,wpass,creation_progress)
                        .then( (w) => {
                            // get wallet parameters
                            wallet = w;
                            seed = wallet.mnemonic;
                            priv = wallet.privateKey;
                            addr = wallet.address;
                            document.getElementById('input').style.display="none";
                            // Show data
                            document.getElementById('out_address').innerHTML = "Address : " + addr;
                        })
                        .catch( reason => {
                            alert(reason);
                        });
                }
            }

            function callTX () {
                var contract_abi ='[{"constant": true,"inputs": [{"name": "timestamp","type": "uint256"}],"name": "getDate","outputs": [{"name": "time","type": "bytes4"}],"payable": false,"stateMutability": "pure","type": "function"}]';
                var contract_address = "0x2Da417702eFAA884eC9769545c3e16ba3Ae1d2FC";
                var contract = new ethers.Contract(contract_address, contract_abi, provider);
                // var date = new Date();
                contract.getDate(parseInt(Date.now()/1000)).then((d) => {
                    var year= parseInt(d.substring(2,6), 16);
                    var month = parseInt(d.substring(6,8), 16);
                    var day = parseInt(d.substring(8,10), 16);
                    
                    document.getElementById('out_Date').innerHTML = year+"/"+month+"/"+day;
                    }) ;
            }

            async function  notarize() {
                var contract_abi ='[{"constant": false,"inputs": [{"name": "_hash","type": "bytes32"},{"name": "_email","type": "string"},{"name": "_storage","type": "string"}],"name": "doLog","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"inputs": [],"payable": false,"stateMutability": "nonpayable","type": "constructor"},{"anonymous": false,"inputs": [{"indexed": true,"name": "_hash","type": "bytes32"},{"indexed": false,"name": "_email","type": "string"},{"indexed": false,"name": "_storage","type": "string"}],"name": "logData","type": "event"}]';
                var contract_address = "0x8258f4dea122619198ab9c8a42e7e882cb148396";
                w1 = wallet.connect(provider);
                console.log("w1 = "+w1);

                // var contract = new ethers.Contract(contract_address, contract_abi, provider);
                // var contractWithSigner = contract.connect(wallet);
                // ... OR ...
                let contractWithSigner = new ethers.Contract(contract_address, contract_abi, w1);
                console.log(contractWithSigner);
                var tx = await contractWithSigner.doLog( document.getElementById('hash').value ,"test JS","ethers");
                console.log(tx);
                console.log(tx.hash);
                await tx.wait();
                document.getElementById('hash').innerHTML = tx;
            }

        </script>

        <h1>Use Wallet from JSON</h1>
        <div id="input">
            <h2>Load Wallet</h2>
            Load your JSON wallet file :<br>
            <input type="file" id="files" name="files" width="80%"/> 
            <p></p>
            <div>
                Input your password here.<br>
                <input id="password" placeholder="Type your password here" size="80" type="text" />
                <div id="pwstrength">&nbsp;</div>
            </div>
            <p></p>
            <button id="btn_restore" onclick="importJ()">Restore wallet from Seed</button>    
            <div id="out_creation"></div>   
        </div>
        
        <hr>

        <div id="out_address"></div>
        <div id="out_balance"></div>

        <div id="div_provider" style="display: block" onchange="selectProvider()">
            <form name="f1">
                <select name="select_provider">
                    <option>Select your provider...</option>
                    <option value="M">Metamask</option>
                    <!-- <option value="I">Local IPC Mainnet</option>
                    <option value="T">Local IPC Testnet</option> -->
                    <option value="L">Local RPC</option>
                    <option value="R">Remote RPC</option>
                </select>   
                <div id="out_provider"></div>
            </form>
        </div>
        <button id="btn_tx" onclick="callTX()">Get date</button> <div id="out_Date"></div>
        <p>
        <div id="div_notarize">
            <input id="hash" placeholder="Type a hash here" size="80" type="text" /><br>
            <button id="btn_notarie" onclick="notarize()">Notarize</button> 
            <div id="out_notarize"></div>
        </div>
    </body>
</html>


<!-- 

// This only works on JsonRpcProviders, and returns a JsonRpcSigner
const signer = provider.getSigner();
const resp = signer.sendTransaction(tx);



 -->